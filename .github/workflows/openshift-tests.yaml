on:
  issue_comment:
    types:
      - created
jobs:
  openshift-tests:
    # This job only runs for '[test]' pull request comments by owner, member
    name: "integration tests: RHEL-8 OpenShift 4"
    runs-on: ubuntu-20.04

    if: |
      github.event.issue.pull_request
      && contains(github.event.comment.body, '[test]')
      && contains(fromJson('["OWNER", "MEMBER"]'), github.event.comment.author_association)
    steps:
      - name: Checkout repo
        uses: actions/checkout@v3
        with:
          ref: "refs/pull/${{ github.event.issue.number }}/head"

      - name: Schedule tests for RHEL 8
        uses: sclorg/testing-farm-as-github-action@v1
        with:
          api_key:  ${{ secrets.TF_INTERNAL_API_KEY }}
          compose:  "RHEL-8.6.0-Nightly"
          git_url:  "https://gitlab.cee.redhat.com/platform-eng-core-services/sclorg-tmt-plans"
          git_ref:  "main"
          tf_scope: "private"
          tmt_plan_regex: "rhel8-openshift-4"
          pull_request_status_name: "RHEL8 - OpenShift 4"
          variables: "REPO_URL=$GITHUB_SERVER_URL/$GITHUB_REPOSITORY;REPO_NAME=$GITHUB_REPOSITORY;PR_NUMBER=${{ github.event.issue.number }}"
